<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>OS table configurator</title></head><body> <main> <div class="target"> <div id="popup-msg"></div> <div id="copy-to-clipboard">⎘</div> <div id="download-as-excel" title="Скачать в виде Excel">Excel</div> <div id="download-as-config-json" title="Скачать кофигурацию в виде JSON">JSON</div> <div id="targetTableContainer"></div> </div> <div class="target-add"> <div> Роли описанные но не примененные к серверу: <div id="targetLostRoles" class="pb-sm"></div> Роли без описания: <div id="targetEmptyRoles" class="pb-sm"></div> Сервера без сайта: <div id="targetLostServers" class="pb-sm"></div> Пересечение roleId: <div id="targetIntersectionRoleId" class="pb-sm"></div> </div> </div> <div class="source"> <textarea id="sourceJSON" disabled></textarea> </div> </main> <script type="module">const e=[{name:"system",caption:"Системные роли",typeroles:["mic","mdc","sdc","ic","rpco","rpci","mware"]},{name:"sip",caption:"SIP роли",typeroles:["esg","b2b","sg","sg","conf","sel","sr"]},{name:"store",caption:"Хранилища",typeroles:["sq","logstore","callstore","st","sts"]},{name:"media",caption:"Медиа",typeroles:["bgmg","mgc","mg","mix"]},{name:"func",caption:"Фнукциональные роли",typeroles:["scr","ivr","cdr","jrnl","recmover","vmail"]},{name:"add",caption:"Сопутсвующие роли",typeroles:["huntq","wssubscr","ws","usr","rsv"]}],t="os-table-body",r="os-table-server-info",n=e=>{let t=e.content,r=e=>t.structure.filter(t=>t.site==e).map(e=>e.servers).flat(),n=e=>t.sites.find(t=>t.name==e)?.domains??[];return{config:e,sitesWithSrv:t.sites.sort((e,t)=>e.name>t.name?1:-1).map(e=>(r(e.name)??[]).sort().map(t=>({siteName:e.name,srvName:t.server}))).flat().map((e,t,r)=>({...e,isBorderLeft:e.siteName!=r[t-1]?.siteName})),getServersBySite:r,getServerRolesByName:t=>e.content.structure.map(e=>e.servers).flat().find(e=>e.server==t),getRoleByName:e=>t.roles.find(t=>t.name==e),getServerByName:e=>t.servers.find(t=>t.name==e),getDomainsBySite:e=>n(e).map(e=>t.domains.find(t=>t.name==e)),getLostRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat();return e.content.roles.filter(e=>!t.includes(e.name))},getLostServers:()=>{let t=e.content.servers,r=e.content.structure.map(e=>e.servers.map(e=>e.server)).flat();return t.filter(e=>!r.includes(e.name))},getIntersectionedRoles:()=>{let t=e.content.roles,r=e=>"roleid"in e?e.roleid:void 0;return t.filter((e,t,n)=>{let l=r(e);return!!l&&n.filter(e=>l==r(e)).length>1})},getEmptyRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat(),r=e.content.roles.map(e=>e.name);return t.filter(e=>!r.includes(e))}}},l=(e,t)=>(t&&e.classList.add("site-border-left"),e),s=e=>e.sitesWithSrv.map(e=>{let t=document.createElement("td");return t.colSpan=5,t.classList.add("os-table-caption-site"),t.textContent=e.siteName+"-"+e.srvName,l(t,e.isBorderLeft),t}),o=["Role","Group","Order","RoleID","MGC_gr"],a=e=>e.sitesWithSrv.map(e=>o.map((t,r)=>{let n=document.createElement("td");return n.classList.add("os-table-header"),n.textContent=t,0==r&&l(n,e.isBorderLeft),n})).flat(),i=(r,n)=>{let s=e.find(e=>e.name==n);if(console.log(s),n&&!s)throw Error("Group not found! > "+n);let o=r.sitesWithSrv.map(t=>{let{server:l,roles:o}=r.getServerRolesByName(t.srvName)??{};if(!o)return{siteSrv:t,rolesGG:[]};let a=o.map(e=>r.getRoleByName(e));return{siteSrv:t,rolesGG:(()=>{if(n)return a.filter(e=>!!e&&s.typeroles.includes(e.roletype));{let t=e.map(e=>[...e.typeroles]).flat();return a.filter(e=>!!e&&!t.includes(e.roletype))}})()}});console.log(r.sitesWithSrv),console.log(o);let a=[...o].sort((e,t)=>e.rolesGG.length>t.rolesGG.length?1:-1).reverse()[0].rolesGG.length+1;return console.log(a),[(()=>{let e=document.createElement("tr");return e.title=n?"":"Роли без группы",o.forEach(t=>{let r=e.insertCell();r.colSpan=5,r.classList.add("os-table-header-midle"),r.innerText=(s?s.caption:"Иное")+" - "+t.siteSrv.srvName,l(r,t.siteSrv.isBorderLeft)}),e})(),...[...Array(a)].map((e,r)=>{let n=document.createElement("tr");return o.forEach(e=>{let s=e.rolesGG[r],o=n.insertCell();o.classList.add(t),o.innerHTML=s?s.name:"&nbsp;",o.title=JSON.stringify(s,null,2),l(o,e.siteSrv.isBorderLeft);let a=n.insertCell();a.classList.add(t),a.innerHTML=s&&"group"in s?""+s.group:"&nbsp;";let i=n.insertCell();i.classList.add(t),i.innerHTML=s&&"order"in s?""+s.order:"&nbsp;";let d=n.insertCell();d.classList.add(t),d.innerHTML=s&&"roleid"in s?""+s.roleid:"&nbsp;";let m=n.insertCell();return m.classList.add(t),m.innerHTML=s&&"mgcgroup"in s?""+s.mgcgroup:"&nbsp;",o}),n})]},d=e=>e.sitesWithSrv.map(t=>{let n=document.createElement("td");n.colSpan=5,n.classList.add(r);let s=e.getServerByName(t.srvName);return n.innerHTML=[(s?.ifaces||[]).map(e=>`${e.key} - ${e.value}`).join("<br/>"),`\u{41E}\u{43F}\u{438}\u{441}\u{430}\u{43D}\u{438}\u{435}:${s?.descr||""} `.split("\n").join("<br/>")].join("<br/>"),n.title=JSON.stringify(s,null,2),l(n,t.isBorderLeft),n}).flat(),m=e=>e.sitesWithSrv.map(t=>{let n=document.createElement("td");n.colSpan=5,n.classList.add(r);let s=e.getDomainsBySite(t.siteName);return n.innerHTML=s.map(e=>`${e?.name??"?"} - ${e?.fqdn??"?"}`).join("<br/>"),n.title=JSON.stringify(s,null,2),l(n,t.isBorderLeft),n}).flat(),c=e=>{let t=n(JSON.parse(e)),r=document.createElement("div"),l=t.getLostRoles().map(e=>e.name);return r.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),r},u=e=>{let t=n(JSON.parse(e)),r=document.createElement("div"),l=t.getEmptyRoles();return r.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),r},p=e=>{let t=n(JSON.parse(e)),r=document.createElement("div"),l=t.getLostServers().map(e=>e.name);return r.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),r},g=e=>{let t=n(JSON.parse(e)),r=document.createElement("div"),l=t.getIntersectionedRoles().map(e=>e.name);return r.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),r},f=e=>{let t=n(JSON.parse(e)),r=document.createElement("table");return r.insertRow().append(...s(t)),r.insertRow().append(...a(t)),r.tBodies[0].append(...i(t,"system")),r.tBodies[0].append(...i(t,"sip")),r.tBodies[0].append(...i(t,"store")),r.tBodies[0].append(...i(t,"media")),r.tBodies[0].append(...i(t,"func")),r.tBodies[0].append(...i(t,"add")),r.tBodies[0].append(...i(t)),r.insertRow().append(...m(t)),r.insertRow().append(...d(t)),r},v=(()=>{let e;let t="showed";return(r,n=2e3)=>{clearTimeout(e);let l=document.getElementById("popup-msg");l&&(l.setAttribute(t,"true"),l.innerText=r,e=setTimeout(()=>l.removeAttribute(t),n))}})();{let e=document.getElementById("copy-to-clipboard");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){v("Ошибка копирования!");return}let t=[...e.querySelectorAll("tr")].map(e=>[...e.cells].map(e=>`"${e.innerText}"${[...Array(e.colSpan)].map(e=>",").join("")}`).map(e=>e.replace(/\r\n|\r/mg,"\n"))).join("\n");navigator.clipboard.writeText(t),v("Скопировано!")})}{let e=document.getElementById("download-as-excel");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){v("Ошибка копирования!");return}let t=e.outerHTML,r=`osconfig_${y(new Date)}.xls`,n=window.document.createElement("a");n.href=`data:application/vnd.ms-excel;base64,${S(t)}`,n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n),v("Скачивание XLS...")})}{let e=document.getElementById("download-as-config-json");e&&(e.onclick=()=>{let e=document.querySelector("#sourceJSON");if(null==e){v("Ошибка копирования!");return}let t=e.value;console.log(t);let r=`osconfig_${y(new Date)}.json`,n=window.document.createElement("a");n.href=`data:application/json;base64,${S(t)}`,n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n),v("Скачивание JSON...")})}const S=e=>window.btoa(unescape(encodeURIComponent(e))),y=e=>{let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),s=String(e.getMinutes()).padStart(2,"0");return`${t}-${r}-${n}_${l}-${s}`},b=document.getElementById("sourceJSON"),h=fetch("./config.json").then(e=>e.text()).catch(e=>console.error(e));h.then(e=>b.value=e),h.then(e=>{let t=f(e);document.getElementById("targetTableContainer").append(t);let r=c(e);document.getElementById("targetLostRoles").append(r);let n=u(e);document.getElementById("targetEmptyRoles").append(n);let l=p(e);document.getElementById("targetLostServers").append(l);let s=g(e);document.getElementById("targetIntersectionRoleId").append(s)});</script> <style>.pb-sm{padding-bottom:5px}*{box-sizing:border-box}body{background-color:#7fffd4}table{border-collapse:collapse}.site-border-left.site-border-left{border-left:5px solid #000}.source #sourceJSON{width:95%;height:80%}.os-table-caption-site{text-align:center;background:#fff;border:1px solid #000;font-size:1.3em;font-weight:700;position:sticky;top:1px}.os-table-header{text-align:center;background:#fed932;border:1px solid #000;font-size:.9em;font-weight:700;position:sticky;top:1.7em}.os-table-header-midle{text-align:center;border:1px solid #000;font-size:.9em}.os-table-body{text-align:center;border:1px solid #000;font-size:.9em;font-weight:700}.os-table-server-info{vertical-align:top;border:1px solid #000;padding:.1em}#targetTableContainer table tr>td:nth-child(5n+1),#targetTableContainer table tr>td:nth-child(5n+2),#targetTableContainer table tr>td:nth-child(5n+3),#targetTableContainer table tr>td:nth-child(5n+4),#targetTableContainer table tr>td:nth-child(5n+5){max-width:5em}#download-as-excel{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:1em;left:1em}#download-as-config-json{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:.01em;left:1em}#copy-to-clipboard{color:#00f;z-index:99999;cursor:pointer;display:none;position:fixed;top:.85em;left:2em}#popup-msg{z-index:999999;background-color:#b79500;border:1px solid #000;padding:.5em;display:none;position:absolute;top:1em;right:1em}#popup-msg[showed]{display:block}.target-add>div{display:inline-block;position:sticky;left:0}</style> </body></html>