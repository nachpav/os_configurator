<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>OS table configurator</title></head><body> <main> <div class="target"> <div id="popup-msg"></div> <div id="copy-to-clipboard">⎘</div> <div id="download-as-excel" title="Скачать в виде Excel">Excel</div> <div id="download-as-config-json" title="Скачать кофигурацию в виде JSON">JSON</div> <div id="targetTableContainer"></div> </div> <div class="target-add"> <div> <div class="pb-sm pl-lg" title="Подсказка: выводит номера id которые ещё не заняты в конфиге"> Следующие RoleId: <span id="targetNextRoleId">-</span> <br> Следующие Group: <span id="targetNextGroup">-</span> </div> Роли описанные но не примененные к серверу: <div id="targetLostRoles" class="pb-sm"></div> Роли без описания: <div id="targetEmptyRoles" class="pb-sm"></div> Сервера без сайта: <div id="targetLostServers" class="pb-sm"></div> Пересечение roleId: <div id="targetIntersectionRoleId" class="pb-sm"></div> Пересечение group на разных сайтах или typerole: <div id="targetIntersectionGroup" class="pb-sm"></div> </div> </div> <div class="source"> <textarea id="sourceJSON" disabled></textarea> </div> </main> <script type="module">const e=[{name:"system",caption:"Системные роли",typeroles:["mic","mdc","sdc","ic","rpco","rpci","mware"]},{name:"sip",caption:"SIP роли",typeroles:["esg","b2b","sg","sg","conf","sel","sr"]},{name:"store",caption:"Хранилища",typeroles:["sq","logstore","callstore","st","sts"]},{name:"media",caption:"Медиа",typeroles:["bgmg","mgc","mg","mix"]},{name:"func",caption:"Фнукциональные роли",typeroles:["scr","ivr","cdr","jrnl","recmover","vmail"]},{name:"add",caption:"Сопутсвующие роли",typeroles:["huntq","wssubscr","ws","usr","rsv"]}],t="os-table-body",r="os-table-server-info",n=e=>{let t=e.content,r=e=>t.structure.filter(t=>t.site==e).map(e=>e.servers).flat(),n=t=>{for(let r of e.content.structure){let e=r.site;for(let n of r.servers){let r=n.server;if(n.roles.find(e=>e==t))return{siteName:e,serverName:r,roleName:t}}}},l=e=>t.sites.find(t=>t.name==e)?.domains??[],o=(e,t=7)=>{let r=e.sort((e,t)=>e-t);return{innerIds:(()=>{let e=[];for(let n=0;n<r[r.length-1]&&!(e.length>t);n++)r.includes(n)||e.push(n);return e})(),maxId:r[r.length-1]}};return{config:e,sitesWithSrv:t.sites.sort((e,t)=>e.name>t.name?1:-1).map(e=>(r(e.name)??[]).sort().map(t=>({siteName:e.name,srvName:t.server}))).flat().map((e,t,r)=>({...e,isBorderLeft:e.siteName!=r[t-1]?.siteName})),getServersBySite:r,getServerRolesByName:t=>e.content.structure.map(e=>e.servers).flat().find(e=>e.server==t),getSiteForRoleName:n,getRoleByName:e=>t.roles.find(t=>t.name==e),getServerByName:e=>t.servers.find(t=>t.name==e),getDomainsBySite:e=>l(e).map(e=>t.domains.find(t=>t.name==e)),getLostRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat();return e.content.roles.filter(e=>!t.includes(e.name))},getLostServers:()=>{let t=e.content.servers,r=e.content.structure.map(e=>e.servers.map(e=>e.server)).flat();return t.filter(e=>!r.includes(e.name))},getIntersectionedRolesId:()=>{let t=e.content.roles,r=e=>"roleid"in e?e.roleid:void 0;return t.filter((e,t,n)=>{let l=r(e);return!!l&&n.filter(e=>l==r(e)).length>1})},getIntersectionedGroupOnDifferentSites:()=>{let t=e.content.roles,r=e=>"group"in e?e.group:void 0;return t.map(e=>({role:e,roletype:e.roletype,group:r(e),rolePath:n(e.name)})).filter(e=>e.rolePath).filter(e=>e.group).filter((e,t,r)=>{let n=r.filter(t=>e.group==t.group);return[...n.filter(t=>e.rolePath?.siteName!=t.rolePath?.siteName),...n.filter(t=>e.roletype!=t.roletype)].length>0})},getNextRoleId:()=>{let t=o(e.content.roles.map(e=>"roleid"in e&&e.roleid).filter(e=>!1!==e));return{innerIds:t.innerIds,nextId:t.maxId+1}},getNextGroup:()=>{let t=o(e.content.roles.map(e=>"group"in e&&e.group).filter(e=>!1!==e),10);return{innerIds:t.innerIds,nextId:t.maxId+1}},getEmptyRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat(),r=e.content.roles.map(e=>e.name);return t.filter(e=>!r.includes(e))}}},l=(e,t)=>(t&&e.classList.add("site-border-left"),e),o=e=>e.sitesWithSrv.map(e=>{let t=document.createElement("td");return t.colSpan=5,t.classList.add("os-table-caption-site"),t.textContent=e.siteName+"-"+e.srvName,l(t,e.isBorderLeft),t}),s=["Role","Group","Order","RoleID","MGC_gr"],a=e=>e.sitesWithSrv.map(e=>s.map((t,r)=>{let n=document.createElement("td");return n.classList.add("os-table-header"),n.textContent=t,0==r&&l(n,e.isBorderLeft),n})).flat(),i=(r,n)=>{let o=e.find(e=>e.name==n);if(n&&!o)throw Error("Group not found! > "+n);let s=r.sitesWithSrv.map(t=>{let{server:l,roles:s}=r.getServerRolesByName(t.srvName)??{};if(!s)return{siteSrv:t,rolesGG:[]};let a=s.map(e=>r.getRoleByName(e));return{siteSrv:t,rolesGG:(()=>{if(n)return a.filter(e=>!!e&&o.typeroles.includes(e.roletype));{let t=e.map(e=>[...e.typeroles]).flat();return a.filter(e=>!!e&&!t.includes(e.roletype))}})()}}),a=[...s].sort((e,t)=>e.rolesGG.length>t.rolesGG.length?1:-1).reverse()[0].rolesGG.length+1;return[(()=>{let e=document.createElement("tr");return e.title=n?"":"Роли без группы",s.forEach(t=>{let r=e.insertCell();r.colSpan=5,r.classList.add("os-table-header-midle"),r.innerText=(o?o.caption:"Иное")+" - "+t.siteSrv.srvName,l(r,t.siteSrv.isBorderLeft)}),e})(),...[...Array(a)].map((e,r)=>{let n=document.createElement("tr");return s.forEach(e=>{let o=e.rolesGG[r],s=n.insertCell();s.classList.add(t),s.innerHTML=o?o.name:"&nbsp;",s.title=JSON.stringify(o,null,2),l(s,e.siteSrv.isBorderLeft);let a=n.insertCell();a.classList.add(t),a.innerHTML=o&&"group"in o?""+o.group:"&nbsp;";let i=n.insertCell();i.classList.add(t),i.innerHTML=o&&"order"in o?""+o.order:"&nbsp;";let d=n.insertCell();d.classList.add(t),d.innerHTML=o&&"roleid"in o?""+o.roleid:"&nbsp;";let m=n.insertCell();return m.classList.add(t),m.innerHTML=o&&"mgcgroup"in o?""+o.mgcgroup:"&nbsp;",s}),n})]},d=e=>e.sitesWithSrv.map(t=>{let n=document.createElement("td");n.colSpan=5,n.classList.add(r);let o=e.getServerByName(t.srvName);return n.innerHTML=[(o?.ifaces||[]).map(e=>`${e.key} - ${e.value}`).join("<br/>"),`\u{41E}\u{43F}\u{438}\u{441}\u{430}\u{43D}\u{438}\u{435}:${o?.descr||""} `.split("\n").join("<br/>")].join("<br/>"),n.title=JSON.stringify(o,null,2),l(n,t.isBorderLeft),n}).flat(),m=e=>e.sitesWithSrv.map(t=>{let n=document.createElement("td");n.colSpan=5,n.classList.add(r);let o=e.getDomainsBySite(t.siteName);return n.innerHTML=o.map(e=>`${e?.name??"?"} - ${e?.fqdn??"?"}`).join("<br/>"),n.title=JSON.stringify(o,null,2),l(n,t.isBorderLeft),n}).flat(),u=e=>{let t=document.createElement("div"),r=e.getLostRoles().map(e=>e.name);return t.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${r.length}, - `+r.join(", "),t},c=e=>{let t=document.createElement("div"),r=e.getEmptyRoles();return t.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${r.length}, - `+r.join(", "),t},p=e=>{let t=document.createElement("div"),r=e.getLostServers().map(e=>e.name);return t.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${r.length}, - `+r.join(", "),t},g=e=>{let t=document.createElement("div"),r=e.getIntersectionedRolesId().map(e=>e.name);return t.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${r.length}, - `+r.join(", "),t},f=e=>{let t=document.createElement("div"),r=e.getIntersectionedGroupOnDifferentSites().map(e=>e.role.name);return t.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${r.length}, - `+r.join(", "),t},v=e=>{let t=document.createElement("span"),r=e.getNextRoleId();return t.innerText=` [ ${r.innerIds.join(" , ")} , ... , ${r.nextId} ]`,t},y=e=>{let t=document.createElement("span"),r=e.getNextGroup();return t.innerText=` [ ${r.innerIds.join(" , ")} , ... , ${r.nextId} ]`,t},S=e=>{let t=document.createElement("table");return t.insertRow().append(...o(e)),t.insertRow().append(...a(e)),t.tBodies[0].append(...i(e,"system")),t.tBodies[0].append(...i(e,"sip")),t.tBodies[0].append(...i(e,"store")),t.tBodies[0].append(...i(e,"media")),t.tBodies[0].append(...i(e,"func")),t.tBodies[0].append(...i(e,"add")),t.tBodies[0].append(...i(e)),t.insertRow().append(...m(e)),t.insertRow().append(...d(e)),t},h=(()=>{let e;let t="showed";return(r,n=2e3)=>{clearTimeout(e);let l=document.getElementById("popup-msg");l&&(l.setAttribute(t,"true"),l.innerText=r,e=setTimeout(()=>l.removeAttribute(t),n))}})();{let e=document.getElementById("copy-to-clipboard");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){h("Ошибка копирования!");return}let t=[...e.querySelectorAll("tr")].map(e=>[...e.cells].map(e=>`"${e.innerText}"${[...Array(e.colSpan)].map(e=>",").join("")}`).map(e=>e.replace(/\r\n|\r/mg,"\n"))).join("\n");navigator.clipboard.writeText(t),h("Скопировано!")})}{let e=document.getElementById("download-as-excel");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){h("Ошибка копирования!");return}let t=e.outerHTML,r=`osconfig_${E(new Date)}.xls`,n=window.document.createElement("a");n.href=`data:application/vnd.ms-excel;base64,${I(t)}`,n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n),h("Скачивание XLS...")})}{let e=document.getElementById("download-as-config-json");e&&(e.onclick=()=>{let e=document.querySelector("#sourceJSON");if(null==e){h("Ошибка копирования!");return}let t=e.value,r=`osconfig_${E(new Date)}.json`,n=window.document.createElement("a");n.href=`data:application/json;base64,${I(t)}`,n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n),h("Скачивание JSON...")})}const I=e=>window.btoa(unescape(encodeURIComponent(e))),E=e=>{let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${t}-${r}-${n}_${l}-${o}`},b=document.getElementById("sourceJSON"),B=fetch("./config.json").then(e=>e.text()).catch(e=>console.error(e));B.then(e=>b.value=e),B.then(e=>{let t=n(JSON.parse(e)),r=S(t);document.getElementById("targetTableContainer").append(r);let l=u(t);document.getElementById("targetLostRoles").append(l);let o=c(t);document.getElementById("targetEmptyRoles").append(o);let s=p(t);document.getElementById("targetLostServers").append(s);let a=g(t);document.getElementById("targetIntersectionRoleId").append(a);let i=f(t);document.getElementById("targetIntersectionGroup").append(i);let d=v(t);document.getElementById("targetNextRoleId").append(d);let m=y(t);document.getElementById("targetNextGroup").append(m)});</script> <style>.pb-sm{padding-bottom:5px}.pl-lg{padding-left:20px}*{box-sizing:border-box}body{background-color:#7fffd4}table{border-collapse:collapse}.site-border-left.site-border-left{border-left:5px solid #000}.source #sourceJSON{width:95%;height:80%}.os-table-caption-site{text-align:center;background:#fff;border:1px solid #000;font-size:1.3em;font-weight:700;position:sticky;top:1px}.os-table-header{text-align:center;background:#fed932;border:1px solid #000;font-size:.9em;font-weight:700;position:sticky;top:1.7em}.os-table-header-midle{text-align:center;border:1px solid #000;font-size:.9em}.os-table-body{text-align:center;border:1px solid #000;font-size:.9em;font-weight:700}.os-table-server-info{vertical-align:top;border:1px solid #000;padding:.1em}#targetTableContainer table tr>td:nth-child(5n+1){max-width:15em}#targetTableContainer table tr>td:nth-child(5n+2),#targetTableContainer table tr>td:nth-child(5n+3),#targetTableContainer table tr>td:nth-child(5n+4),#targetTableContainer table tr>td:nth-child(5n+5){max-width:5em}#download-as-excel{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:1em;left:1em}#download-as-config-json{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:.01em;left:1em}#copy-to-clipboard{color:#00f;z-index:99999;cursor:pointer;display:none;position:fixed;top:.85em;left:2em}#popup-msg{z-index:999999;background-color:#b79500;border:1px solid #000;padding:.5em;display:none;position:absolute;top:1em;right:1em}#popup-msg[showed]{display:block}.target-add>div{display:inline-block;position:sticky;left:0}</style> </body></html>