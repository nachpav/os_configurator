<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>OS table configurator</title></head><body> <main> <div class="target"> <div id="popup-msg"></div> <div id="copy-to-clipboard">⎘</div> <div id="download-as-excel" title="Скачать в виде Excel">Excel</div> <div id="download-as-config-json" title="Скачать кофигурацию в виде JSON">JSON</div> <div id="targetTableContainer"></div> </div> <div class="target-add"> <div> Роли описанные но не примененные к серверу: <div id="targetLostRoles" class="pb-sm"></div> Роли без описания: <div id="targetEmptyRoles" class="pb-sm"></div> Сервера без сайта: <div id="targetLostServers" class="pb-sm"></div> Пересечение roleId: <div id="targetIntersectionRoleId" class="pb-sm"></div> </div> </div> <div class="source"> <textarea id="sourceJSON" disabled></textarea> </div> </main> <script type="module">const e=[{name:"system",caption:"Системные роли",typeroles:["mic","mdc","sdc","ic","rpco","rpci","mware"]},{name:"sip",caption:"SIP роли",typeroles:["esg","b2b","sg","sg","conf","sel","sr"]},{name:"store",caption:"Хранилища",typeroles:["sq","logstore","callstore","st","sts"]},{name:"media",caption:"Медиа",typeroles:["bgmg","mgc","mg","mix"]},{name:"func",caption:"Фнукциональные роли",typeroles:["scr","ivr","cdr","jrnl","recmover","vmail"]},{name:"add",caption:"Сопутсвующие роли",typeroles:["huntq","wssubscr","ws","usr","rsv"]}],t="os-table-body",n="os-table-server-info",r=e=>{let t=e.content,n=e=>t.structure.filter(t=>t.site==e).map(e=>e.servers).flat(),r=e=>t.sites.find(t=>t.name==e)?.domains??[];return{config:e,sitesWithSrv:t.sites.sort((e,t)=>e.name>t.name?1:-1).map(e=>(n(e.name)??[]).sort().map(t=>({siteName:e.name,srvName:t.server}))).flat(),getServersBySite:n,getServerRolesByName:t=>e.content.structure.map(e=>e.servers).flat().find(e=>e.server==t),getRoleByName:e=>t.roles.find(t=>t.name==e),getServerByName:e=>t.servers.find(t=>t.name==e),getDomainsBySite:e=>r(e).map(e=>t.domains.find(t=>t.name==e)),getLostRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat();return e.content.roles.filter(e=>!t.includes(e.name))},getLostServers:()=>{let t=e.content.servers,n=e.content.structure.map(e=>e.servers.map(e=>e.server)).flat();return t.filter(e=>!n.includes(e.name))},getIntersectionedRoles:()=>{let t=e.content.roles,n=e=>"roleid"in e?e.roleid:void 0;return t.filter((e,t,r)=>{let l=n(e);return!!l&&r.filter(e=>l==n(e)).length>1})},getEmptyRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat(),n=e.content.roles.map(e=>e.name);return t.filter(e=>!n.includes(e))}}},l=e=>e.sitesWithSrv.map(e=>{let t=document.createElement("td");return t.colSpan=5,t.classList.add("os-table-caption-site"),t.textContent=e.siteName+"-"+e.srvName,t}),o=["Role","Group","Order","RoleID","MGC_gr"],s=e=>e.sitesWithSrv.map(e=>o.map(e=>{let t=document.createElement("td");return t.classList.add("os-table-header"),t.textContent=e,t})).flat(),a=(n,r)=>{let l=e.find(e=>e.name==r);if(console.log(l),r&&!l)throw Error("Group not found! > "+r);let o=n.sitesWithSrv.map(t=>{let{server:o,roles:s}=n.getServerRolesByName(t.srvName)??{};if(!s)return{siteSrv:t,rolesGG:[]};let a=s.map(e=>n.getRoleByName(e));return{siteSrv:t,rolesGG:(()=>{if(r)return a.filter(e=>!!e&&l.typeroles.includes(e.roletype));{let t=e.map(e=>[...e.typeroles]).flat();return a.filter(e=>!!e&&!t.includes(e.roletype))}})()}});console.log(n.sitesWithSrv),console.log(o);let s=[...o].sort((e,t)=>e.rolesGG.length>t.rolesGG.length?1:-1).reverse()[0].rolesGG.length+1;return console.log(s),[(()=>{let e=document.createElement("tr");return e.title=r?"":"Роли без группы",o.forEach(t=>{let n=e.insertCell();n.colSpan=5,n.classList.add("os-table-header-midle"),n.innerText=(l?l.caption:"Иное")+" - "+t.siteSrv.srvName}),e})(),...[...Array(s)].map((e,n)=>{let r=document.createElement("tr");return o.forEach(e=>{let l=e.rolesGG[n],o=r.insertCell();o.classList.add(t),o.innerHTML=l?l.name:"&nbsp;",o.title=JSON.stringify(l,null,2);let s=r.insertCell();s.classList.add(t),s.innerHTML=l&&"group"in l?""+l.group:"&nbsp;";let a=r.insertCell();a.classList.add(t),a.innerHTML=l&&"order"in l?""+l.order:"&nbsp;";let i=r.insertCell();i.classList.add(t),i.innerHTML=l&&"roleid"in l?""+l.roleid:"&nbsp;";let d=r.insertCell();return d.classList.add(t),d.innerHTML=l&&"mgcgroup"in l?""+l.mgcgroup:"&nbsp;",o}),r})]},i=e=>e.sitesWithSrv.map(t=>{let r=document.createElement("td");r.colSpan=5,r.classList.add(n);let l=e.getServerByName(t.srvName);return r.innerHTML=[(l?.ifaces||[]).map(e=>`${e.key} - ${e.value}`).join("<br/>"),`\u{41E}\u{43F}\u{438}\u{441}\u{430}\u{43D}\u{438}\u{435}:${l?.descr||""} `.split("\n").join("<br/>")].join("<br/>"),r.title=JSON.stringify(l,null,2),r}).flat(),d=e=>e.sitesWithSrv.map(t=>{let r=document.createElement("td");r.colSpan=5,r.classList.add(n);let l=e.getDomainsBySite(t.siteName);return r.innerHTML=l.map(e=>`${e?.name??"?"} - ${e?.fqdn??"?"}`).join("<br/>"),r.title=JSON.stringify(l,null,2),r}).flat(),c=e=>{let t=r(JSON.parse(e)),n=document.createElement("div"),l=t.getLostRoles().map(e=>e.name);return n.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),n},m=e=>{let t=r(JSON.parse(e)),n=document.createElement("div"),l=t.getEmptyRoles();return n.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),n},u=e=>{let t=r(JSON.parse(e)),n=document.createElement("div"),l=t.getLostServers().map(e=>e.name);return n.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),n},p=e=>{let t=r(JSON.parse(e)),n=document.createElement("div"),l=t.getIntersectionedRoles().map(e=>e.name);return n.innerText=`\u{412}\u{441}\u{435}\u{433}\u{43E}:${l.length}, - `+l.join(", "),n},g=e=>{let t=r(JSON.parse(e)),n=document.createElement("table");return n.insertRow().append(...l(t)),n.insertRow().append(...s(t)),n.tBodies[0].append(...a(t,"system")),n.tBodies[0].append(...a(t,"sip")),n.tBodies[0].append(...a(t,"store")),n.tBodies[0].append(...a(t,"media")),n.tBodies[0].append(...a(t,"func")),n.tBodies[0].append(...a(t,"add")),n.tBodies[0].append(...a(t)),n.insertRow().append(...d(t)),n.insertRow().append(...i(t)),n},v=(()=>{let e;let t="showed";return(n,r=2e3)=>{clearTimeout(e);let l=document.getElementById("popup-msg");l&&(l.setAttribute(t,"true"),l.innerText=n,e=setTimeout(()=>l.removeAttribute(t),r))}})();{let e=document.getElementById("copy-to-clipboard");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){v("Ошибка копирования!");return}let t=[...e.querySelectorAll("tr")].map(e=>[...e.cells].map(e=>`"${e.innerText}"${[...Array(e.colSpan)].map(e=>",").join("")}`).map(e=>e.replace(/\r\n|\r/mg,"\n"))).join("\n");navigator.clipboard.writeText(t),v("Скопировано!")})}{let e=document.getElementById("download-as-excel");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){v("Ошибка копирования!");return}let t=e.outerHTML,n=`osconfig_${S(new Date)}.xls`,r=window.document.createElement("a");r.href=`data:application/vnd.ms-excel;base64,${f(t)}`,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),v("Скачивание XLS...")})}{let e=document.getElementById("download-as-config-json");e&&(e.onclick=()=>{let e=document.querySelector("#sourceJSON");if(null==e){v("Ошибка копирования!");return}let t=e.value;console.log(t);let n=`osconfig_${S(new Date)}.json`,r=window.document.createElement("a");r.href=`data:application/json;base64,${f(t)}`,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),v("Скачивание JSON...")})}const f=e=>window.btoa(unescape(encodeURIComponent(e))),S=e=>{let t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${t}-${n}-${r}_${l}-${o}`},y=document.getElementById("sourceJSON"),b=fetch("./config.json").then(e=>e.text()).catch(e=>console.error(e));b.then(e=>y.value=e),b.then(e=>{let t=g(e);document.getElementById("targetTableContainer").append(t);let n=c(e);document.getElementById("targetLostRoles").append(n);let r=m(e);document.getElementById("targetEmptyRoles").append(r);let l=u(e);document.getElementById("targetLostServers").append(l);let o=p(e);document.getElementById("targetIntersectionRoleId").append(o)});</script> <style>.pb-sm{padding-bottom:5px}*{box-sizing:border-box}body{background-color:#7fffd4}table{border-collapse:collapse}.source #sourceJSON{width:95%;height:80%}.os-table-caption-site{text-align:center;background:#fff;border:1px solid #000;font-size:1.3em;font-weight:700;position:sticky;top:1px}.os-table-header{text-align:center;background:#fed932;border:1px solid #000;font-size:.9em;font-weight:700;position:sticky;top:1.7em}.os-table-header-midle{text-align:center;border:1px solid #000;font-size:.9em}.os-table-body{text-align:center;border:1px solid #000;font-size:.9em;font-weight:700}.os-table-server-info{vertical-align:top;border:1px solid #000;padding:.1em}#targetTableContainer table tr>td:nth-child(5n+1),#targetTableContainer table tr>td:nth-child(5n+2),#targetTableContainer table tr>td:nth-child(5n+3),#targetTableContainer table tr>td:nth-child(5n+4),#targetTableContainer table tr>td:nth-child(5n+5){max-width:5em}#download-as-excel{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:1em;left:1em}#download-as-config-json{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:.01em;left:1em}#copy-to-clipboard{color:#00f;z-index:99999;cursor:pointer;display:none;position:fixed;top:.85em;left:2em}#popup-msg{z-index:999999;background-color:#b79500;border:1px solid #000;padding:.5em;display:none;position:absolute;top:1em;right:1em}#popup-msg[showed]{display:block}.target-add>div{display:inline-block;position:sticky;left:0}</style> </body></html>