<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>OS table configurator</title></head><body> <main> <div class="target"> <div id="popup-msg"></div> <div id="copy-to-clipboard">⎘</div> <div id="download-as-excel" title="Скачать в виде Excel">Excel</div> <div id="download-as-config-json" title="Скачать кофигурацию в виде JSON">JSON</div> <div id="targetTableContainer"></div> </div> <div class="target-add"> Роли описанные но не примененные к серверу: <div id="targetLostRoles"></div> Роли без описания: <div id="targetEmptyRoles"></div> </div> <div class="source"> <textarea id="sourceJSON" disabled></textarea> </div> </main> <script type="module">const e=[{name:"system",caption:"Системные роли",typeroles:["mic","mdc","sdc","ic","rpco","rpci","mware"]},{name:"sip",caption:"SIP роли",typeroles:["esg","b2b","sg","sg","conf","sel","sr"]},{name:"store",caption:"Хранилища",typeroles:["sq","logstore","callstore","st","sts"]},{name:"media",caption:"Медиа",typeroles:["bgmg","mgc","mg","mix"]},{name:"func",caption:"Фнукциональные роли",typeroles:["scr","ivr","cdr","jrnl","recmover","vmail"]},{name:"add",caption:"Сопутсвующие роли",typeroles:["huntq","wssubscr","ws","usr","rsv"]}],t="os-table-body",r=e=>{let t=e.content,r=e=>t.structure.filter(t=>t.site==e).map(e=>e.servers).flat(),n=t.sites.sort((e,t)=>e.name>t.name?1:-1),l=n.map(e=>(r(e.name)??[]).sort().map(t=>({siteName:e.name,srvName:t.server}))).flat();return{config:e,sitesWithSrv:l,getServersBySite:r,getServerRolesByName:t=>e.content.structure.map(e=>e.servers).flat().find(e=>e.server==t),getRoleByName:e=>t.roles.find(t=>t.name==e),getServerByName:e=>t.servers.find(t=>t.name==e),getLostRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat();return e.content.roles.filter(e=>!t.includes(e.name))},getEmptyRoles:()=>{let t=e.content.structure.map(e=>[...e.servers.map(e=>e.roles).flat()]).flat(),r=e.content.roles.map(e=>e.name);return t.filter(e=>!r.includes(e))}}},n=e=>e.sitesWithSrv.map(e=>{let t=document.createElement("td");return t.colSpan=5,t.classList.add("os-table-caption-site"),t.textContent=e.siteName+"-"+e.srvName,t}),l=["Role","Group","Order","RoleID","MGC_gr"],o=e=>e.sitesWithSrv.map(e=>l.map(e=>{let t=document.createElement("td");return t.classList.add("os-table-header"),t.textContent=e,t})).flat(),s=(r,n)=>{let l=e.find(e=>e.name==n);if(console.log(l),n&&!l)throw Error("Group not found! > "+n);let o=r.sitesWithSrv.map(t=>{let{server:o,roles:s}=r.getServerRolesByName(t.srvName)??{};if(!s)return{siteSrv:t,rolesGG:[]};let a=s.map(e=>r.getRoleByName(e)),i=(()=>{if(n)return a.filter(e=>!!e&&l.typeroles.includes(e.roletype));{let t=e.map(e=>[...e.typeroles]).flat();return a.filter(e=>!!e&&!t.includes(e.roletype))}})();return{siteSrv:t,rolesGG:i}});console.log(r.sitesWithSrv),console.log(o);let s=[...o].sort((e,t)=>e.rolesGG.length>t.rolesGG.length?1:-1).reverse()[0].rolesGG.length+1;console.log(s);let a=(()=>{let e=document.createElement("tr");return e.title=n?"":"Роли без группы",o.forEach(t=>{let r=e.insertCell();r.colSpan=5,r.classList.add("os-table-header-midle"),r.innerText=(l?l.caption:"Иное")+" - "+t.siteSrv.srvName}),e})(),i=[...Array(s)].map((e,r)=>{let n=document.createElement("tr");return o.forEach(e=>{let l=e.rolesGG[r],o=n.insertCell();o.classList.add(t),o.innerHTML=l?l.name:"&nbsp;",o.title=JSON.stringify(l,null,2);let s=n.insertCell();s.classList.add(t),s.innerHTML=l&&"group"in l?""+l.group:"&nbsp;";let a=n.insertCell();a.classList.add(t),a.innerHTML=l&&"order"in l?""+l.order:"&nbsp;";let i=n.insertCell();i.classList.add(t),i.innerHTML=l&&"roleid"in l?""+l.roleid:"&nbsp;";let d=n.insertCell();return d.classList.add(t),d.innerHTML=l&&"mgcgroup"in l?""+l.mgcgroup:"&nbsp;",o}),n});return[a,...i]},a=e=>e.sitesWithSrv.map(t=>{let r=document.createElement("td");r.colSpan=5,r.classList.add("os-table-server-info");let n=e.getServerByName(t.srvName);return r.innerHTML=[(n?.ifaces||[]).map(e=>`${e.key} - ${e.value}`).join("<br/>"),`Описание:${n?.descr||""} `.split("\n").join("<br/>")].join("<br/>"),r.title=JSON.stringify(n,null,2),r}).flat(),i=e=>{let t=JSON.parse(e),n=r(t),l=document.createElement("div"),o=n.getLostRoles().map(e=>e.name);return l.innerText=`Всего:${o.length}, - `+o.join(", "),l},d=e=>{let t=JSON.parse(e),n=r(t),l=document.createElement("div"),o=n.getEmptyRoles();return l.innerText=`Всего:${o.length}, - `+o.join(", "),l},c=e=>{let t=JSON.parse(e),l=r(t),i=document.createElement("table"),d=i.insertRow();d.append(...n(l));let c=i.insertRow();c.append(...o(l)),// const tableRowEmpty = table.insertRow()
// tableRowEmpty.append(...renederHeader2(context))
i.tBodies[0].append(...s(l,"system")),i.tBodies[0].append(...s(l,"sip")),i.tBodies[0].append(...s(l,"store")),i.tBodies[0].append(...s(l,"media")),i.tBodies[0].append(...s(l,"func")),i.tBodies[0].append(...s(l,"add")),i.tBodies[0].append(...s(l));let m=i.insertRow();return m.append(...a(l)),i},m=(()=>{let e;let t="showed";return(r,n=2e3)=>{clearTimeout(e);let l=document.getElementById("popup-msg");l&&(l.setAttribute(t,"true"),l.innerText=r,e=setTimeout(()=>l.removeAttribute(t),n))}})();{let e=document.getElementById("copy-to-clipboard");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){m("Ошибка копирования!");return}// Get the text field
let t=[...e.querySelectorAll("tr")].map(e=>[...e.cells].map(e=>`"${e.innerText}"${[...Array(e.colSpan)].map(e=>",").join("")}`).map(e=>e.replace(/\r\n|\r/mg,"\n"))).join("\n");// Copy the text inside the text field
navigator.clipboard.writeText(t),m("Скопировано!")})}{let e=document.getElementById("download-as-excel");e&&(e.onclick=()=>{let e=document.querySelector("#targetTableContainer>table");if(null==e){m("Ошибка копирования!");return}let t=e.outerHTML,r=`osconfig_${u(new Date)}.xls`,n=window.document.createElement("a");n.href=`data:application/vnd.ms-excel;base64,${p(t)}`,n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n),m("Скачивание XLS...")})}{let e=document.getElementById("download-as-config-json");e&&(e.onclick=()=>{let e=document.querySelector("#sourceJSON");if(null==e){m("Ошибка копирования!");return}let t=e.value;console.log(t);let r=`osconfig_${u(new Date)}.json`,n=window.document.createElement("a");n.href=`data:application/json;base64,${p(t)}`,n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n),m("Скачивание JSON...")})}const p=e=>window.btoa(unescape(encodeURIComponent(e))),u=e=>{let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${t}-${r}-${n}_${l}-${o}`},g=document.getElementById("sourceJSON"),y=fetch("./config.json").then(e=>e.text()).catch(e=>console.error(e));//Buffer.from(str, 'utf-8').toString('base64');
y.then(e=>g.value=e),y.then(e=>{let t=c(e);document.getElementById("targetTableContainer").append(t);let r=i(e);document.getElementById("targetLostRoles").append(r);let n=d(e);document.getElementById("targetEmptyRoles").append(n)});</script> <style>*{box-sizing:border-box}body{background-color:#7fffd4}table{border-collapse:collapse}.source #sourceJSON{width:95%;height:80%}.os-table-caption-site{text-align:center;background:#fff;border:1px solid #000;font-size:1.3em;font-weight:700;position:sticky;top:1px}.os-table-header{text-align:center;background:#fed932;border:1px solid #000;font-size:.9em;font-weight:700;position:sticky;top:1.7em}.os-table-header-midle{text-align:center;border:1px solid #000;font-size:.9em}.os-table-body{text-align:center;border:1px solid #000;font-size:.9em;font-weight:700}.os-table-server-info{vertical-align:top;border:1px solid #000;padding:.1em}#targetTableContainer table tr>td:nth-child(5n+1),#targetTableContainer table tr>td:nth-child(5n+2),#targetTableContainer table tr>td:nth-child(5n+3),#targetTableContainer table tr>td:nth-child(5n+4),#targetTableContainer table tr>td:nth-child(5n+5){max-width:5em}#download-as-excel{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:1em;left:1em}#download-as-config-json{color:#00f;z-index:99999;cursor:pointer;position:fixed;top:.01em;left:1em}#copy-to-clipboard{color:#00f;z-index:99999;cursor:pointer;display:none;position:fixed;top:.85em;left:2em}#popup-msg{z-index:999999;background-color:#b79500;border:1px solid #000;padding:.5em;display:none;position:absolute;top:1em;right:1em}#popup-msg[showed]{display:block}</style> </body></html>